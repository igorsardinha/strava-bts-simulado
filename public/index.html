<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>2ª Etapa - Simulado BTS</title>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
		<style>
			body {
				font-family: sans-serif;
				text-align: center;
				margin: 0;
				padding-top: 70px;
				background-color: #f4f4f4;
			}
			#logo {
				border-radius: 50%;
				width: 30px;
				height: 30px;
				border: 1px solid #ccc;
			}
			.app-header {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				background-color: #fff;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
				padding: 10px 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				z-index: 100;
			}
			.header-left {
				display: flex;
				align-items: center;
			}
			.header-right {
				display: flex;
				align-items: center;
				gap: 20px;
			}
			.header-menu-links {
				display: flex;
				align-items: center;
				gap: 10px;
			}
			.header-menu-links a {
				text-decoration: none;
				color: #333;
				padding: 5px 10px;
				border-radius: 5px;
				transition: background-color 0.3s;
			}
			.header-menu-links a:hover {
				background-color: #f2f2f2;
			}
			.hamburger {
				display: none;
				font-size: 1.5em;
				cursor: pointer;
			}
			.user-info {
				display: flex;
				align-items: center;
				gap: 10px;
			}
			.user-info img {
				border-radius: 50%;
				width: 30px;
				height: 30px;
				border: 1px solid #ccc;
				object-fit: cover;
			}
			.user-info .user-name {
				font-size: 1em;
				margin: 0;
			}
			.disconnect-icon {
				background-color: transparent;
				border: none;
				color: #f44336;
				font-size: 1.2em;
				cursor: pointer;
				padding: 5px;
			}
			.disconnect-icon:hover {
				color: #d32f2f;
			}
			.btn {
				color: white;
				padding: 10px 20px;
				text-decoration: none;
				border-radius: 5px;
				font-size: 1em;
				border: none;
				cursor: pointer;
				display: inline-block;
				margin: 5px;
			}
			.btn-strava {
				background-color: #fc4c02;
			}
			.btn-ranking {
				background-color: #007bff;
			}
			.btn-admin {
				background-color: #6c757d;
			}
			.activity-list {
				text-align: left;
				margin: 20px auto;
				max-width: 800px;
				width: 90%;
			}
			.activity-list h3 {
				border-bottom: 2px solid #ccc;
				padding-bottom: 5px;
			}
			.activity-item {
				border: 1px solid #eee;
				padding: 10px;
				margin-bottom: 5px;
				border-radius: 5px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				cursor: pointer;
				position: relative;
			}
			.activity-item.inactive-activity {
				opacity: 0.6;
				background-color: #f9f9f9;
				cursor: pointer;
			}
			.activity-item.inactive-activity::after {
				content: "DESCONSIDERADA";
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				font-size: 0.9em;
				color: #f44336;
				font-weight: bold;
				background-color: rgba(255, 255, 255, 0.8);
				padding: 5px 10px;
				border-radius: 5px;
			}
			.activity-info {
				display: flex;
				align-items: center;
			}
			.activity-emoji {
				font-size: 1.5em;
				margin-right: 10px;
			}
			#liveStopwatchContainer {
				margin-top: 20px;
				padding: 15px;
				background-color: #f2f2f2;
				border-radius: 10px;
				max-width: 800px;
				margin: 20px auto;
			}
			#liveStopwatchDisplay {
				font-size: 2.5em;
				font-weight: bold;
				color: #28a745;
			}
			.display {
				font-size: 6em;
				font-weight: bold;
				margin-bottom: 30px;
				color: #0056b3;
				display: flex;
				gap: 5px;
				justify-content: center;
			}
			#liveStopwatchStatus {
				font-size: 0.9em;
				color: #555;
			}
			.connect-btn-container {
				margin-top: 20px;
			}
			.activity-details-panel {
				padding: 15px;
				background-color: #fff;
				border: 1px solid #ddd;
				border-radius: 5px;
				margin-top: 5px;
				margin-bottom: 10px;
				text-align: left;
			}
			.detail-item {
				padding: 8px 0;
				border-bottom: 1px solid #eee;
				display: flex;
				gap: 10px;
				align-items: center;
			}
			.detail-item:last-child {
				border-bottom: none;
			}
			.detail-item .label {
				font-weight: bold;
				width: 120px;
				text-align: left;
			}
			.detail-item .value {
				text-align: left;
			}
			.detail-item .icon {
				margin-right: 5px;
			}

			@media (max-width: 768px) {
				.app-header {
					flex-wrap: wrap;
					padding: 10px;
				}
				.header-left {
					width: 100%;
					justify-content: space-between;
					gap: 0;
				}
				.header-right {
					flex-direction: column;
					position: absolute;
					top: 50px;
					left: 0;
					width: 100%;
					background-color: #fff;
					box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
					display: none;
					padding: 10px 0;
					z-index: 99;
				}
				.header-right.active {
					display: flex;
				}
				.header-menu-links {
					flex-direction: column;
					width: 100%;
					align-items: center;
					gap: 5px;
				}
				.header-menu-links a {
					width: 90%;
					text-align: center;
					box-sizing: border-box;
					margin: 5px 0;
				}
				.user-info {
					width: 100%;
					padding: 10px 0;
					justify-content: center;
					margin-left: 0;
					border-top: 1px solid #eee;
					margin-top: 10px;
				}
				.hamburger {
					display: block;
				}
			}
		</style>
	</head>
	<body>
		<header class="app-header">
			<div class="header-left">
				<img src="../assets/logo_bts.png" alt="Logo BTS" id="logo" />
				<span class="hamburger" id="hamburgerBtn">&#9776;</span>
			</div>
			<div class="header-right" id="header-right-container">
				<div class="header-menu-links" id="header-menu">
					<a href="/ranking.html">Ver Ranking</a>
					<a href="/admin.html">Painel Admin</a>
					<a href="/stopwatch.html">Cronômetro</a>
				</div>
				<div id="userInfo" class="user-info" style="display: none">
					<img
						id="userPhoto"
						src="https://via.placeholder.com/30"
						alt="Foto do Usuário" />
					<span class="user-name"><span id="userName"></span></span>
					<button id="disconnectBtn" class="disconnect-icon">
						<i class="fa-solid fa-power-off"></i>
					</button>
				</div>
			</div>
		</header>

		<div id="main-page">
			<h1>2ª Etapa - Simulado BTS</h1>
			<p id="introText">
				Clique no botão abaixo para autenticar sua conta e permitir o acesso às
				suas atividades.
			</p>

			<div id="liveStopwatchContainer">
				<h2>Tempo do Simulado</h2>
				<div id="liveStopwatchDisplay" class="mainDisplay">00:00:00:00</div>
				<p id="liveStopwatchStatus">Não iniciado</p>
			</div>

			<div class="connect-btn-container" id="connectContainer">
				<a href="/api/strava/auth" id="connectBtn">
					<img
						src="/assets/btn_strava_connect_with_orange_x2.svg"
						alt="Conectar com Strava"
						style="max-width: 200px; height: auto" />
				</a>
			</div>

			<div id="controls" style="display: none">
				<hr />
				<h2>Minhas Atividades</h2>
				<button id="sendActivitiesBtn" class="btn btn-strava">
					Enviar minhas atividades
				</button>
			</div>

			<div id="activitiesList" class="activity-list" style="display: none">
				<h3>Últimas 10 Atividades Enviadas</h3>
			</div>
		</div>

		<script>
			const connectBtn = document.getElementById("connectBtn");
			const connectContainer = document.getElementById("connectContainer");
			const userInfoDiv = document.getElementById("userInfo");
			const userPhoto = document.getElementById("userPhoto");
			const userNameSpan = document.getElementById("userName");
			const controlsDiv = document.getElementById("controls");
			const sendActivitiesBtn = document.getElementById("sendActivitiesBtn");
			const disconnectBtn = document.getElementById("disconnectBtn");
			const activitiesListDiv = document.getElementById("activitiesList");
			const mainPage = document.getElementById("main-page");
			const hamburgerBtn = document.getElementById("hamburgerBtn");
			const headerMenu = document.getElementById("header-menu");
			const headerRightContainer = document.getElementById(
				"header-right-container"
			);

			let liveStopwatchInterval = null;
			let currentlyOpenDetailsId = null;

			const formatTime = (seconds) => {
				const h = Math.floor(seconds / 3600);
				const m = Math.floor((seconds % 3600) / 60);
				const s = seconds % 60;
				return `${h}h ${m}m ${s}s`;
			};

			const formatTimeMs = (ms) => {
				let totalSeconds = Math.floor(ms / 1000);
				let totalMinutes = Math.floor(totalSeconds / 60);
				let totalHours = Math.floor(totalMinutes / 60);

				let displayHours = String(totalHours).padStart(2, "0");
				let displayMinutes = String(totalMinutes % 60).padStart(2, "0");
				let displaySeconds = String(totalSeconds % 60).padStart(2, "0");
				let displayMilliseconds = String(Math.floor((ms % 1000) / 10)).padStart(
					2,
					"0"
				);

				return `${displayHours}:${displayMinutes}:${displaySeconds}:${displayMilliseconds}`;
			};

			const formatPace = (distance, time) => {
				if (distance === 0 || time === 0) return "N/A";
				const paceInSecondsPerKm = (time * 1000) / distance;
				const minutes = Math.floor(paceInSecondsPerKm / 60);
				const seconds = Math.floor(paceInSecondsPerKm % 60);
				return `${minutes}m ${seconds}s /km`;
			};

			const getActivityEmoji = (type) => {
				switch (type) {
					case "Ride":
						return "🚲";
					case "Run":
						return "🏃‍♂️";
					case "Walk":
						return "🚶‍♀️";
					case "Swim":
						return "🏊‍♀️";
					case "Hike":
						return "⛰️";
					case "Transition":
						return "➡️";
					default:
						return "💪";
				}
			};

			const fetchLiveStopwatchState = async () => {
				try {
					const response = await fetch("/api/strava/stopwatch/real-time-state");
					if (response.ok) {
						const state = await response.json();
						let displayTime = state.elapsedTime;
						if (state.isRunning) {
							const timeElapsedSinceSave = Date.now() - state.lastSaved;
							displayTime += timeElapsedSinceSave;
							liveStopwatchStatus.textContent = `Em andamento`;
						} else {
							displayTime = state.elapsedTime;
							liveStopwatchStatus.textContent = `Parado`;
						}
						liveStopwatchDisplay.textContent = formatTimeMs(displayTime);
					} else {
						liveStopwatchDisplay.textContent = "00:00:00:00";
						liveStopwatchStatus.textContent = "Não iniciado";
					}
				} catch (error) {
					console.error("Erro ao buscar estado do cronômetro:", error);
					liveStopwatchDisplay.textContent = "---";
					liveStopwatchStatus.textContent = "Erro de conexão";
				}
			};

			const checkStatus = async () => {
				try {
					const response = await fetch("/api/strava/status");
					const data = await response.json();
					if (data.status === "connected") {
						connectContainer.style.display = "none";
						introText.textContent =
							"Você já está conectado ao Strava. Use o botão abaixo para enviar suas atividades.";
						controlsDiv.style.display = "block";

						if (window.innerWidth > 768) {
							headerRightContainer.appendChild(userInfoDiv);
						} else {
							headerMenu.appendChild(userInfoDiv);
						}

						userInfoDiv.style.display = "flex";
						loadUserInfo();
						loadSavedActivities();
					} else {
						connectContainer.style.display = "block";
						introText.textContent =
							"Clique no botão abaixo para autenticar sua conta e permitir o acesso às suas atividades.";
						controlsDiv.style.display = "none";
						userInfoDiv.style.display = "none";
					}
				} catch (error) {
					console.error("Erro ao verificar status:", error);
				}
			};

			const loadUserInfo = async () => {
				try {
					const response = await fetch("/api/strava/user");
					const user = await response.json();
					userNameSpan.textContent = user.name;
					userPhoto.src =
						user.profile_photo || "https://via.placeholder.com/60";
				} catch (error) {
					console.error("Erro ao carregar informações do usuário:", error);
				}
			};

			const loadSavedActivities = async () => {
				try {
					const response = await fetch("/api/strava/saved-activities");
					const data = await response.json();
					if (data.activities) {
						displayActivities(data.activities, data.configDate);
					}
				} catch (error) {
					console.error("Erro ao carregar atividades salvas:", error);
				}
			};

			const displayActivities = (activities, configDate) => {
				if (!activities || activities.length === 0) {
					activitiesListDiv.style.display = "none";
					return;
				}

				activitiesListDiv.innerHTML = "<h3>Últimas 10 Atividades Enviadas</h3>";
				const lastTenActivities = activities.slice(0, 10);

				lastTenActivities.forEach((activity) => {
					const distanceInKm = (activity.distance / 1000).toFixed(2);
					const emoji = getActivityEmoji(activity.type);
					const activityDate = activity.start_date_local.split("T")[0];

					const activityItem = document.createElement("div");
					activityItem.className = "activity-item";

					if (configDate && activityDate !== configDate) {
						activityItem.classList.add("inactive-activity");
					}

					activityItem.innerHTML = `
          <div class="activity-info">
            <div class="activity-emoji">${emoji}</div>
            <div>
              <strong>${activity.name}</strong> <br>
              ${distanceInKm} km
            </div>
          </div>
        `;

					const detailsContainerId = `activity-details-${activity.id}`;

					activityItem.addEventListener("click", () => {
						if (currentlyOpenDetailsId === activity.id) {
							const openPanel = document.getElementById(detailsContainerId);
							if (openPanel) {
								openPanel.remove();
								currentlyOpenDetailsId = null;
							}
						} else {
							if (currentlyOpenDetailsId !== null) {
								const previousPanel = document.getElementById(
									`activity-details-${currentlyOpenDetailsId}`
								);
								if (previousPanel) {
									previousPanel.remove();
								}
							}
							currentlyOpenDetailsId = activity.id;
							const detailsPanel = document.createElement("div");
							detailsPanel.id = detailsContainerId;
							detailsPanel.className = "activity-details-panel";
							detailsPanel.innerHTML = "<p>Carregando detalhes...</p>";
							activityItem.insertAdjacentElement("afterend", detailsPanel);
							fetchActivityDetails(activity.id, detailsPanel);
						}
					});

					activitiesListDiv.appendChild(activityItem);
				});
				activitiesListDiv.style.display = "block";
			};

			const fetchActivityDetails = async (activityId, detailsPanel) => {
				try {
					const response = await fetch(`/api/strava/activity/${activityId}`);
					const activity = await response.json();
					if (activity) {
						const start = new Date(activity.start_date);
						detailsPanel.innerHTML = `
            <div class="detail-item">
              <span class="label"><span class="icon">📅</span> Data:</span>
              <span class="value">${start.toLocaleDateString()}</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">${getActivityEmoji(
								activity.type
							)}</span> Tipo:</span>
              <span class="value">${activity.type}</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">📏</span> Distância:</span>
              <span class="value">${(activity.distance / 1000).toFixed(
								2
							)} km</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">⏰</span> Duração:</span>
              <span class="value">${formatTime(activity.moving_time)}</span>
            </div>
            <div class="detail-item">
                <span class="label"><span class="icon">⏱️</span> Ritmo Médio:</span>
                <span class="value">${formatPace(
									activity.distance,
									activity.moving_time
								)}</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">⛰️</span> Elevação:</span>
              <span class="value">${activity.total_elevation_gain} metros</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">💨</span> Velocidade Média:</span>
              <span class="value">${(activity.average_speed * 3.6).toFixed(
								2
							)} km/h</span>
            </div>
            ${
							activity.average_heartrate
								? `
            <div class="detail-item">
              <span class="label"><span class="icon">❤️</span> HR:</span>
              <span class="value">${activity.average_heartrate} BPM</span>
            </div>
            `
								: ""
						}
          `;
					} else {
						detailsPanel.innerHTML =
							"<p>Detalhes da atividade não encontrados.</p>";
					}
				} catch (error) {
					console.error("Erro ao buscar detalhes da atividade:", error);
					detailsPanel.innerHTML = "<p>Erro ao carregar detalhes.</p>";
				}
			};

			sendActivitiesBtn.addEventListener("click", async () => {
				if (userInfoDiv.style.display !== "flex") {
					alert("Você precisa se conectar ao Strava primeiro.");
					return;
				}
				try {
					await fetch("/api/strava/activities");
					alert("Atividades enviadas e salvas com sucesso!");
					const savedActivitiesResponse = await fetch(
						"/api/strava/saved-activities"
					);
					const savedActivitiesData = await savedActivitiesResponse.json();
					displayActivities(
						savedActivitiesData.activities,
						savedActivitiesData.configDate
					);
				} catch (error) {
					alert("Erro ao enviar atividades.");
					console.error(error);
				}
			});

			disconnectBtn.addEventListener("click", async () => {
				try {
					await fetch("/api/strava/disconnect");
					alert("Você foi desconectado com sucesso.");
					window.location.reload();
				} catch (error) {
					console.error("Erro ao desconectar:", error);
					alert("Não foi possível desconectar. Tente novamente.");
				}
			});

			hamburgerBtn.addEventListener("click", () => {
				const menuContainer = document.getElementById("header-right-container");
				menuContainer.classList.toggle("active");
			});

			checkStatus();
			setInterval(fetchLiveStopwatchState, 100);
		</script>
	</body>
</html>
