<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>2ª Etapa - Simulado BTS</title>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
		<link rel="stylesheet" href="assets/css/index.css" />
	</head>
	<body>
		<header class="app-header">
			<div class="header-left">
				<a href="/">
					<img src="../assets/logo_bts.png" alt="Logo BTS" id="logo" />
				</a>
				<h3 class="bts_title">Bebedouro Triathlon Squad</h3>
				<span class="hamburger" id="hamburgerBtn">&#9776;</span>
			</div>
			<div class="header-right" id="header-right-container">
				<div class="header-menu-links" id="header-menu">
					<a href="/ranking.html">Ver Ranking</a>
					<a href="/admin.html">Painel Admin</a>
					<a href="/stopwatch.html">Cronômetro</a>
				</div>
				<div id="userInfo" class="user-info" style="display: none">
					<img
						id="userPhoto"
						src="https://via.placeholder.com/30"
						alt="Foto do Usuário" />
					<span class="user-name"><span id="userName"></span></span>
					<button id="disconnectBtn" class="disconnect-icon">
						<i class="fa-solid fa-power-off"></i>
					</button>
				</div>
			</div>
		</header>

		<div id="main-page">
			<h1>2ª Etapa - Simulado BTS</h1>
			<p id="introText">
				Clique no botão abaixo para autenticar sua conta e permitir o acesso às
				suas atividades.
			</p>

			<div id="liveStopwatchContainer">
				<h2>Tempo do Simulado</h2>
				<div id="liveStopwatchDisplay">00:00:00:00</div>
				<p id="liveStopwatchStatus">Não iniciado</p>
			</div>

			<div class="connect-btn-container" id="connectContainer">
				<a href="/api/strava/auth" id="connectBtn">
					<img
						src="/assets/btn_strava_connect_with_orange_x2.svg"
						alt="Conectar com Strava"
						style="max-width: 200px; height: auto" />
				</a>
			</div>

			<div id="controls" style="display: none">
				<hr />
				<h2>Minhas Atividades</h2>
				<button id="sendActivitiesBtn" class="btn btn-strava">
					Enviar minhas atividades
				</button>
			</div>

			<div id="activitiesList" class="activity-list" style="display: none">
				<h3>Últimas 10 Atividades Enviadas</h3>
			</div>
		</div>

		<script>
			const connectBtn = document.getElementById("connectBtn");
			const connectContainer = document.getElementById("connectContainer");
			const userInfoDiv = document.getElementById("userInfo");
			const userPhoto = document.getElementById("userPhoto");
			const userNameSpan = document.getElementById("userName");
			const controlsDiv = document.getElementById("controls");
			const sendActivitiesBtn = document.getElementById("sendActivitiesBtn");
			const disconnectBtn = document.getElementById("disconnectBtn");
			const activitiesListDiv = document.getElementById("activitiesList");
			const mainPage = document.getElementById("main-page");
			const hamburgerBtn = document.getElementById("hamburgerBtn");
			const headerMenu = document.getElementById("header-menu");
			const headerRightContainer = document.getElementById(
				"header-right-container"
			);

			let liveStopwatchInterval = null;
			let currentlyOpenDetailsId = null;

			const formatTime = (seconds) => {
				const h = Math.floor(seconds / 3600);
				const m = Math.floor((seconds % 3600) / 60);
				const s = seconds % 60;
				return `${h}h ${m}m ${s}s`;
			};

			const formatTimeMs = (ms) => {
				let totalSeconds = Math.floor(ms / 1000);
				let totalMinutes = Math.floor(totalSeconds / 60);
				let totalHours = Math.floor(totalMinutes / 60);

				let displayHours = String(totalHours).padStart(2, "0");
				let displayMinutes = String(totalMinutes % 60).padStart(2, "0");
				let displaySeconds = String(totalSeconds % 60).padStart(2, "0");
				let displayMilliseconds = String(Math.floor((ms % 1000) / 10)).padStart(
					2,
					"0"
				);

				return `${displayHours}:${displayMinutes}:${displaySeconds}:${displayMilliseconds}`;
			};

			const formatPace = (distance, time) => {
				if (distance === 0 || time === 0) return "N/A";
				const paceInSecondsPerKm = (time * 1000) / distance;
				const minutes = Math.floor(paceInSecondsPerKm / 60);
				const seconds = Math.floor(paceInSecondsPerKm % 60);
				return `${minutes}m ${seconds}s /km`;
			};

			const getActivityEmoji = (type) => {
				switch (type) {
					case "Ride":
						return "🚲";
					case "Run":
						return "🏃‍♂️";
					case "Walk":
						return "🚶‍♀️";
					case "Swim":
						return "🏊‍♀️";
					case "Hike":
						return "⛰️";
					case "Transition":
						return "➡️";
					default:
						return "💪";
				}
			};

			const fetchLiveStopwatchState = async () => {
				try {
					const response = await fetch("/api/strava/stopwatch/real-time-state");
					if (response.ok) {
						const state = await response.json();
						let displayTime = state.elapsedTime;
						if (state.isRunning) {
							const timeElapsedSinceSave = Date.now() - state.lastSaved;
							displayTime += timeElapsedSinceSave;
							liveStopwatchStatus.textContent = `Em andamento`;
						} else {
							displayTime = state.elapsedTime;
							liveStopwatchStatus.textContent = `Parado`;
						}
						liveStopwatchDisplay.textContent = formatTimeMs(displayTime);
					} else {
						liveStopwatchDisplay.textContent = "00:00:00:00";
						liveStopwatchStatus.textContent = "Não iniciado";
					}
				} catch (error) {
					console.error("Erro ao buscar estado do cronômetro:", error);
					liveStopwatchDisplay.textContent = "---";
					liveStopwatchStatus.textContent = "Erro de conexão";
				}
			};

			const checkStatus = async () => {
				try {
					const response = await fetch("/api/strava/status");
					const data = await response.json();
					if (data.status === "connected") {
						connectContainer.style.display = "none";
						introText.textContent =
							"Você já está conectado ao Strava. Use o botão abaixo para enviar suas atividades.";
						controlsDiv.style.display = "block";

						if (window.innerWidth > 768) {
							// Desktop: coloca userInfo no header-right
							headerRightContainer.appendChild(userInfoDiv);
						} else {
							// Mobile: coloca userInfo no menu-hamburguer
							headerMenu.appendChild(userInfoDiv);
						}

						userInfoDiv.style.display = "flex";
						loadUserInfo();
						loadSavedActivities();
					} else {
						connectContainer.style.display = "block";
						introText.textContent =
							"Clique no botão abaixo para autenticar sua conta e permitir o acesso às suas atividades.";
						controlsDiv.style.display = "none";
						userInfoDiv.style.display = "none";
					}
				} catch (error) {
					console.error("Erro ao verificar status:", error);
				}
			};

			const loadUserInfo = async () => {
				try {
					const response = await fetch("/api/strava/user");
					const user = await response.json();

					// Verifique se o elemento da foto existe antes de usá-lo
					const userPhotoElement = document.getElementById("userPhoto");
					if (userPhotoElement) {
						userPhotoElement.src =
							user.profile_photo || "https://via.placeholder.com/60";
					}

					// Verifique se o elemento do nome existe
					const userNameElement = document.getElementById("userName");
					if (userNameElement) {
						userNameElement.textContent = user.name;
					}
				} catch (error) {
					console.error("Erro ao carregar informações do usuário:", error);
				}
			};
			const loadSavedActivities = async () => {
				try {
					const response = await fetch("/api/strava/saved-activities");
					const data = await response.json();
					if (data.activities) {
						displayActivities(data.activities, data.configDate);
					}
				} catch (error) {
					console.error("Erro ao carregar atividades salvas:", error);
				}
			};

			const displayActivities = (activities, configDate) => {
				if (!activities || activities.length === 0) {
					activitiesListDiv.style.display = "none";
					return;
				}

				activitiesListDiv.innerHTML = "<h3>Últimas 10 Atividades Enviadas</h3>";
				const lastTenActivities = activities.slice(0, 10);

				lastTenActivities.forEach((activity) => {
					const distanceInKm = (activity.distance / 1000).toFixed(2);
					const emoji = getActivityEmoji(activity.type);
					const activityDate = activity.start_date_local.split("T")[0];

					const activityItem = document.createElement("div");
					activityItem.className = "activity-item";

					if (configDate && activityDate !== configDate) {
						activityItem.classList.add("inactive-activity");
					}

					activityItem.innerHTML = `
          <div class="activity-info">
            <div class="activity-emoji">${emoji}</div>
            <div>
              <strong>${activity.name}</strong> <br>
              ${distanceInKm} km
            </div>
          </div>
        `;

					const detailsContainerId = `activity-details-${activity.id}`;

					activityItem.addEventListener("click", () => {
						if (currentlyOpenDetailsId === activity.id) {
							const openPanel = document.getElementById(detailsContainerId);
							if (openPanel) {
								openPanel.remove();
								currentlyOpenDetailsId = null;
							}
						} else {
							if (currentlyOpenDetailsId !== null) {
								const previousPanel = document.getElementById(
									`activity-details-${currentlyOpenDetailsId}`
								);
								if (previousPanel) {
									previousPanel.remove();
								}
							}
							currentlyOpenDetailsId = activity.id;
							const detailsPanel = document.createElement("div");
							detailsPanel.id = detailsContainerId;
							detailsPanel.className = "activity-details-panel";
							detailsPanel.innerHTML = "<p>Carregando detalhes...</p>";
							activityItem.insertAdjacentElement("afterend", detailsPanel);
							fetchActivityDetails(activity.id, detailsPanel);
						}
					});

					activitiesListDiv.appendChild(activityItem);
				});
				activitiesListDiv.style.display = "block";
			};

			const fetchActivityDetails = async (activityId, detailsPanel) => {
				try {
					const response = await fetch(`/api/strava/activity/${activityId}`);
					const activity = await response.json();
					if (activity) {
						const start = new Date(activity.start_date);
						detailsPanel.innerHTML = `
            <div class="detail-item">
              <span class="label"><span class="icon">📅</span> Data:</span>
              <span class="value">${start.toLocaleDateString()}</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">${getActivityEmoji(
								activity.type
							)}</span> Tipo:</span>
              <span class="value">${activity.type}</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">📏</span> Distância:</span>
              <span class="value">${(activity.distance / 1000).toFixed(
								2
							)} km</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">⏰</span> Duração:</span>
              <span class="value">${formatTime(activity.moving_time)}</span>
            </div>
            <div class="detail-item">
                <span class="label"><span class="icon">⏱️</span> Ritmo Médio:</span>
                <span class="value">${formatPace(
									activity.distance,
									activity.moving_time
								)}</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">⛰️</span> Elevação:</span>
              <span class="value">${activity.total_elevation_gain} metros</span>
            </div>
            <div class="detail-item">
              <span class="label"><span class="icon">💨</span> Velocidade Média:</span>
              <span class="value">${(activity.average_speed * 3.6).toFixed(
								2
							)} km/h</span>
            </div>
            ${
							activity.average_heartrate
								? `
            <div class="detail-item">
              <span class="label"><span class="icon">❤️</span> HR:</span>
              <span class="value">${activity.average_heartrate} BPM</span>
            </div>
            `
								: ""
						}
          `;
					} else {
						detailsPanel.innerHTML =
							"<p>Detalhes da atividade não encontrados.</p>";
					}
				} catch (error) {
					console.error("Erro ao buscar detalhes da atividade:", error);
					detailsPanel.innerHTML = "<p>Erro ao carregar detalhes.</p>";
				}
			};

			sendActivitiesBtn.addEventListener("click", async () => {
				if (userInfoDiv.style.display !== "flex") {
					alert("Você precisa se conectar ao Strava primeiro.");
					return;
				}
				try {
					await fetch("/api/strava/activities");
					alert("Atividades enviadas e salvas com sucesso!");
					const savedActivitiesResponse = await fetch(
						"/api/strava/saved-activities"
					);
					const savedActivitiesData = await savedActivitiesResponse.json();
					displayActivities(
						savedActivitiesData.activities,
						savedActivitiesData.configDate
					);
				} catch (error) {
					alert("Erro ao enviar atividades.");
					console.error(error);
				}
			});

			disconnectBtn.addEventListener("click", async () => {
				try {
					await fetch("/api/strava/disconnect");
					alert("Você foi desconectado com sucesso.");
					window.location.reload();
				} catch (error) {
					console.error("Erro ao desconectar:", error);
					alert("Não foi possível desconectar. Tente novamente.");
				}
			});

			hamburgerBtn.addEventListener("click", () => {
				const menuContainer = document.getElementById("header-right-container");
				menuContainer.classList.toggle("active");
			});

			checkStatus();
			setInterval(fetchLiveStopwatchState, 100);
		</script>
	</body>
</html>
